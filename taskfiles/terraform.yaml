version: "3"

tasks:
  init:
    desc: Initialize terraform
    dir: ./terraform
    cmds:
      - terraform init

  plan:
    desc: Plan terraform changes
    dir: ./terraform
    cmds:
      - terraform plan

  sync:
    desc: Sync terraform outputs to 1Password
    dir: ./terraform
    cmds:
      - |
        echo "ðŸ“ Syncing terraform outputs to 1Password..."
        GATUS_IP=$(terraform output -raw gatus_droplet_ip)
        FOUNDRY_IP=$(terraform output -raw foundry_droplet_ip)

        echo "Gatus IP: $GATUS_IP"
        echo "Foundry IP: $FOUNDRY_IP"

        op item edit nixos --vault kubernetes \
          GATUS_DROPLET_IP[password]="$GATUS_IP" \
          FOUNDRY_DROPLET_IP[password]="$FOUNDRY_IP"

        echo "ðŸ“¦ Updating deploy.json..."
        cd ..
        sed -e "s/GATUS_IP/$GATUS_IP/" -e "s/FOUNDRY_IP/$FOUNDRY_IP/" deploy.json.template > /tmp/deploy.json

        op item edit nixos "deploy.json[text]=$(cat /tmp/deploy.json)"
        jq -c . /tmp/deploy.json | gh secret set DEPLOY_NIX_JSON
        rm /tmp/deploy.json

        echo "âœ… 1Password & GitHub updated"
        echo "   Gatus: $GATUS_IP"
        echo "   Foundry: $FOUNDRY_IP"

  apply:
    desc: Apply terraform and update 1Password with outputs
    dir: ./terraform
    cmds:
      - echo "ðŸš€ Applying terraform..."
      - terraform apply
      - task: sync

  destroy:
    desc: Destroy terraform resources
    dir: ./terraform
    cmds:
      - terraform destroy
