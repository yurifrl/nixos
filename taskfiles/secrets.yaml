version: "3"

tasks:
  load:env:
    desc: Load environment variables
    cmds:
      - op inject -f -i .env.op -o .env
      - op inject -f -i terraform/terraform.tfvars.example.op -o terraform/terraform.tfvars

  load:build:
    desc: Load build secrets (deploy.json from 1Password)
    cmds:
      - |
        echo "deploy.json" >> .git/info/exclude
        op read "op://kubernetes/nixos/deploy.json" -f -o deploy.json
        echo "✅ deploy.json loaded"

  load:
    desc: Load all runtime secrets to both servers
    cmds:
      - task: secrets:load:gatus
      - task: secrets:load:foundry

  load:gatus:
    desc: Load Gatus server secrets
    dir: ./secrets
    vars:
      HOST: "{{.GATUS_DROPLET_USER}}@{{.GATUS_DROPLET_IP}}"
      DIRS: "/etc/tailscale /etc/cloudflared /etc/gatus"
    cmds:
      - echo "Loading secrets for Gatus server..."
      - op read "op://kubernetes/nixos/tailscale-auth.key" -f -o tailscale-auth.key
      - op read "op://kubernetes/nixos/gatus-cloudflared-creds.json" -f -o gatus-cloudflared-creds.json
      - op read "op://kubernetes/nixos/gatus.env" -f -o gatus.env
      - ssh {{.HOST}} "mkdir -p {{.DIRS}}"
      - scp tailscale-auth.key {{.HOST}}:/etc/tailscale/tailscale-auth.key
      - scp gatus-cloudflared-creds.json {{.HOST}}:/etc/cloudflared/config.json
      - scp gatus.env {{.HOST}}:/etc/gatus/gatus.env
      - ssh {{.HOST}} "chmod 600 /etc/tailscale/tailscale-auth.key /etc/cloudflared/config.json /etc/gatus/gatus.env"
      - ssh {{.HOST}} "chown -R tailscale:tailscale /etc/tailscale"
      - ssh {{.HOST}} "chown -R gatus:gatus /etc/gatus"
      - ssh {{.HOST}} "chown -R cloudflared:cloudflared /etc/cloudflared"
      - echo "✅ Gatus secrets loaded successfully"

  load:foundry:
    desc: Load Foundry server secrets
    dir: ./secrets
    vars:
      HOST: "{{.FOUNDRY_DROPLET_USER}}@{{.FOUNDRY_DROPLET_IP}}"
      DIRS: "/etc/tailscale /etc/cloudflared /etc/foundry"
    cmds:
      - echo "Loading secrets for Foundry server..."
      - op read "op://kubernetes/nixos/tailscale-auth.key" -f -o tailscale-auth.key
      - op read "op://kubernetes/nixos/foundry-cloudflared-tunnel.json" -f -o foundry-cloudflared-tunnel.json || op read "op://kubernetes/nixos/foundry-cloudflared-tunnel.json" -f -o foundry-cloudflared-tunnel.json
      - ssh {{.HOST}} "mkdir -p {{.DIRS}}"
      - scp tailscale-auth.key {{.HOST}}:/etc/tailscale/tailscale-auth.key
      - scp foundry-cloudflared-tunnel.json {{.HOST}}:/etc/cloudflared/foundry-tunnel.json
      - ssh {{.HOST}} "chmod 600 /etc/tailscale/tailscale-auth.key /etc/cloudflared/foundry-tunnel.json"
      - ssh {{.HOST}} "chown -R tailscale:tailscale /etc/tailscale"
      - ssh {{.HOST}} "chown -R cloudflared:cloudflared /etc/cloudflared"
      - ssh {{.HOST}} "chown -R foundry:foundry /etc/foundry"
      - echo "✅ Foundry secrets loaded successfully"
