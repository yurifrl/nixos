name: 'Build NixOS Image'
description: 'Build and upload NixOS image to DigitalOcean'

inputs:
  image-name:
    description: 'Name of the image to build (gatus or foundry)'
    required: true

runs:
  using: composite
  steps:
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        flakehub: false

    - name: Enable Nix Flakes
      shell: bash
      run: |
        mkdir -p ~/.config/nix
        echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

    - name: Cache Nix store
      uses: nix-community/cache-nix-action@v6
      with:
        primary-key: "${{ runner.os }}-nix-${{ inputs.image-name }}-${{ hashFiles('**/*.nix') }}"
        paths: |
          /nix/store
          /nix-cache

    - name: Create deploy.json
      shell: bash
      run: |
        printf '%s\n' '${{ env.DEPLOY_NIX_JSON }}' > deploy.json

    - name: Build NixOS Image
      shell: bash
      run: |
        echo "Building ${{ inputs.image-name }} image..."
        nix build .#nixosConfigurations.${{ inputs.image-name }}.config.system.build.digitalOceanImage

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: "${{ env.WIF_PROVIDER }}"
        service_account: "${{ env.WIF_SERVICE_ACCOUNT }}"

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: "${{ env.GCP_PROJECT_ID }}"

    - name: Configure gsutil
      shell: bash
      run: |
        echo "[GSUtil]
        parallel_composite_upload_threshold = 150M" > ~/.boto

    - name: Upload to GCS and create image
      shell: bash
      run: |
        NIXOS_IMAGE_NAME="nixos-${{ inputs.image-name }}-$(date +%Y%m%d-%H%M%S).qcow2.bz2"
        echo "NIXOS_IMAGE_NAME=$NIXOS_IMAGE_NAME" >> $GITHUB_ENV

        cp result/*qcow2.bz2 nixos-${{ inputs.image-name }}.qcow2.bz2

        if [ ! -f nixos-${{ inputs.image-name }}.qcow2.bz2 ]; then
          echo "Error: Failed to copy nixos image file"
          ls -la result/
          exit 1
        fi

        echo "âœ… Found image file: nixos-${{ inputs.image-name }}.qcow2.bz2"
        echo "ðŸ“¦ Image name: $NIXOS_IMAGE_NAME"
        echo "â˜ï¸  GCS Bucket: ${{ env.GCS_BUCKET_NAME }}"

        gsutil cp -v nixos-${{ inputs.image-name }}.qcow2.bz2 "gs://${{ env.GCS_BUCKET_NAME }}/${NIXOS_IMAGE_NAME}"

        if [ $? -ne 0 ]; then
          echo "âŒ Error: Failed to upload to GCS"
          exit 1
        fi

        gsutil acl ch -u AllUsers:R "gs://${{ env.GCS_BUCKET_NAME }}/${NIXOS_IMAGE_NAME}"

        IMAGE_URL="https://storage.googleapis.com/${{ env.GCS_BUCKET_NAME }}/$NIXOS_IMAGE_NAME"
        echo "::add-mask::$IMAGE_URL"
        echo "IMAGE_URL=$IMAGE_URL" >> $GITHUB_ENV

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: "${{ env.DIGITALOCEAN_ACCESS_TOKEN }}"

    - name: Create DigitalOcean Image
      shell: bash
      run: |
        doctl compute image create "$NIXOS_IMAGE_NAME" \
          --region nyc1 \
          --image-url "$IMAGE_URL" \
          --image-description "NixOS ${{ inputs.image-name }} image built on $(date +%Y-%m-%d)"

    - name: Build Summary
      shell: bash
      run: |
        echo "## âœ… Build Complete: ${{ inputs.image-name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Name:** \`$NIXOS_IMAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Location:** [DigitalOcean Custom Images](https://cloud.digitalocean.com/images/custom_images)" >> $GITHUB_STEP_SUMMARY
