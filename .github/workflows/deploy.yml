name: "ðŸš¢ Deploy NixOS Configuration"

on:
  push:
    branches:
      - main
    paths:
      - 'gatus.version'
      - 'foundry.version'
  workflow_dispatch:
    inputs:
      target:
        description: 'Node to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gatus
          - foundry

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [gatus, foundry]
      fail-fast: false  # Continue deploying other nodes if one fails

    # Skip node if manual dispatch targets a specific one
    if: |
      github.event.inputs.target == 'all' ||
      github.event.inputs.target == '' ||
      github.event.inputs.target == matrix.node

    permissions:
      contents: read
      id-token: write

    uses: ./.github/workflows/lib/_deploy-node.yml
    with:
      node_name: ${{ matrix.node }}
    secrets:
      TS_OAUTH_CLIENT_ID: ${{ secrets.TS_OAUTH_CLIENT_ID }}
      TS_OAUTH_SECRET: ${{ secrets.TS_OAUTH_SECRET }}
      DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
