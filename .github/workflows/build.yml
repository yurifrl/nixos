name: "Build NixOS Image"

on:
  push:
    tags:
      - '*'  # Triggers on any tag push
  pull_request:
  workflow_dispatch:  # Keeping manual trigger capability

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v4
      
      # Create a test file instead of building NixOS
      - name: Create test file
        run: |
          echo "This is a test file for NixOS image $(date)" > test.qcow2
          # Create a compressed version
          bzip2 -c test.qcow2 > test.qcow2.bz2

      - name: Upload Image Artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: nixos-digital-ocean-image
          path: test.qcow2.bz2
          retention-days: 5

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # Set up Google Cloud authentication using Workload Identity Federation
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Verify Google Cloud authentication
      - name: Verify Google Cloud Auth
        run: |
          echo "Verifying Google Cloud authentication..."
          gcloud auth list
          gcloud config list project
          echo "Testing bucket access..."
          gsutil ls gs://${{ secrets.GCS_BUCKET_NAME }} || echo "Note: Bucket might not exist yet"

      # Upload to Google Cloud Storage
      - name: Upload to GCS and create image
        run: |
          # Decompress the image
          bunzip2 test.qcow2.bz2
          
          # Upload to GCS with public access
          OBJECT_NAME="nixos-test-$(date +%Y%m%d-%H%M%S).qcow2"
          gsutil cp test.qcow2 gs://${{ secrets.GCS_BUCKET_NAME }}/$OBJECT_NAME
          gsutil acl ch -u AllUsers:R gs://${{ secrets.GCS_BUCKET_NAME }}/$OBJECT_NAME
          
          # Get the public URL
          IMAGE_URL="https://storage.googleapis.com/${{ secrets.GCS_BUCKET_NAME }}/$OBJECT_NAME"
          echo "IMAGE_URL=$IMAGE_URL" >> $GITHUB_ENV

      - name: Create DigitalOcean Image
        run: |
          doctl compute image create nix-image-test \
            --region nyc1 \
            --image-url "${{ env.IMAGE_URL }}" \
            --image-description "Test image created on $(date +%Y-%m-%d)"

      - name: Get Artifact Information
        run: |
          echo "Artifact was uploaded successfully!"
          echo "You can find the artifact in the Actions tab of this repository"
          echo "Direct link to workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # Set the correct project
      - name: Set project
        run: gcloud config set project syscd-443112

      # Enable the IAM API
      - name: Enable IAM API
        run: gcloud services enable iam.googleapis.com

      # Create the Workload Identity Pool
      - name: Create Workload Identity Pool
        run: gcloud iam workload-identity-pools create "github-pool" \
            --project="syscd-443112" \
            --location="global" \
            --display-name="GitHub Actions Pool"

          