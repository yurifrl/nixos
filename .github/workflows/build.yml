name: "<× Build & Release NixOS Images"

on:
  push:
    branches:
      - main
    paths:
      - 'gatus.version'
      - 'foundry.version'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

jobs:
  build-gatus:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if should build
        id: check
        run: |
          # Always build on manual dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if gatus.version changed
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          if echo "$CHANGED" | grep -q "gatus.version"; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and upload
        if: steps.check.outputs.build == 'true'
        uses: ./.github/actions/build-image
        with:
          image-name: gatus
        env:
          DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
          WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
          WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Create release
        if: steps.check.outputs.build == 'true'
        run: |
          VERSION=$(cat gatus.version)
          gh release create "gatus-v${VERSION}" \
            --title "Gatus v${VERSION}" \
            --notes "## Gatus Monitoring Image

          Version: \`${VERSION}\`
          Built from commit: ${{ github.sha }}

          ### Usage
          \`\`\`bash
          # nixos-gatus-YYYYMMDD-HHMMSS
          task nix-deploy-gatus
          \`\`\`" || echo "Release exists"
        env:
          GH_TOKEN: ${{ github.token }}

  build-foundry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if should build
        id: check
        run: |
          # Always build on manual dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if foundry.version changed
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          if echo "$CHANGED" | grep -q "foundry.version"; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and upload
        if: steps.check.outputs.build == 'true'
        uses: ./.github/actions/build-image
        with:
          image-name: foundry
        env:
          DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
          WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
          WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Create release
        if: steps.check.outputs.build == 'true'
        run: |
          VERSION=$(cat foundry.version)
          gh release create "foundry-v${VERSION}" \
            --title "Foundry VTT v${VERSION}" \
            --notes "## Foundry VTT Image

          Version: \`${VERSION}\`
          Built from commit: ${{ github.sha }}

          ### Usage
          \`\`\`bash
          # nixos-foundry-YYYYMMDD-HHMMSS
          task nix-deploy-foundry
          \`\`\`

          **Note**: Requires 50GB volume" || echo "Release exists"
        env:
          GH_TOKEN: ${{ github.token }}
