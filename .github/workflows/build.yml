name: "ðŸ—ï¸ Build & Release"

on:
  push:
    branches:
      - main
    paths:
      - '*.version'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

jobs:
  build-gatus:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || git diff --name-only HEAD~1 HEAD | grep -q "gatus.version"; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - uses: ./.github/actions/build-image
        if: steps.check.outputs.build == 'true'
        with:
          image-name: gatus
        env:
          DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
          WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
          WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Release
        if: steps.check.outputs.build == 'true'
        run: |
          V=$(cat gatus.version)
          gh release create "gatus-v${V}" --title "Gatus v${V}" --notes "Built from ${{ github.sha }}" || true
        env:
          GH_TOKEN: ${{ github.token }}

  build-foundry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || git diff --name-only HEAD~1 HEAD | grep -q "foundry.version"; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - uses: ./.github/actions/build-image
        if: steps.check.outputs.build == 'true'
        with:
          image-name: foundry
        env:
          DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
          WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
          WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Release
        if: steps.check.outputs.build == 'true'
        run: |
          V=$(cat foundry.version)
          gh release create "foundry-v${V}" --title "Foundry v${V}" --notes "Built from ${{ github.sha }}" || true
        env:
          GH_TOKEN: ${{ github.token }}
