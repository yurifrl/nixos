name: "üèóÔ∏è Build NixOS Images"

on:
  push:
    tags:
      - '*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build all images'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  # Detect which images need to be built
  detect-changes:
    uses: ./.github/workflows/_detect-changes.yml
    with:
      force_build_all: ${{ github.event.inputs.force_build == 'true' }}

  # Build Gatus image if needed
  build-gatus:
    needs: detect-changes
    if: needs.detect-changes.outputs.build_gatus == 'true'
    uses: ./.github/workflows/_build-image.yml
    with:
      image_name: gatus
    secrets:
      DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
      DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

  # Build Foundry image if needed
  build-foundry:
    needs: detect-changes
    if: needs.detect-changes.outputs.build_foundry == 'true'
    uses: ./.github/workflows/_build-image.yml
    with:
      image_name: foundry
    secrets:
      DEPLOY_NIX_JSON: ${{ secrets.DEPLOY_NIX_JSON }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
      DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
