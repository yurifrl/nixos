#!/usr/bin/env -S uv run --quiet --script
# /// script
# requires-python = ">=3.11"
# ///
"""Fix foundry hostname typo in 1Password deploy.json"""

import json
import subprocess
import sys

def main():
    # Get current deploy.json from 1Password
    result = subprocess.run(
        ["op", "item", "get", "nixos", "--vault", "Kubernetes", "--format", "json"],
        capture_output=True,
        text=True,
        check=True
    )

    # Parse and find deploy.json field
    item = json.loads(result.stdout)
    deploy_field = next(
        (f for f in item["fields"] if f.get("label") == "deploy.json"),
        None
    )
    if not deploy_field:
        print("Error: deploy.json field not found", file=sys.stderr)
        sys.exit(1)

    current = json.loads(deploy_field["value"])

    # Fix typo: digitalocean-foudry -> digitalocean-foundry-01
    if "foundry" in current.get("nodes", {}):
        hostname = current["nodes"]["foundry"].get("tailscaleHostname", "")
        if "digitalocean-foudry" in hostname:
            current["nodes"]["foundry"]["tailscaleHostname"] = hostname.replace(
                "digitalocean-foudry", "digitalocean-foundry-01"
            )

    # Update 1Password using field ID
    json_str = json.dumps(current)
    result = subprocess.run(
        [
            "op", "item", "edit", "nixos",
            "--vault", "Kubernetes",
            f"yhy7znjb6yif2hykklddrkm7oy[text]={json_str}"
        ],
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        print(f"Error: {result.stderr}", file=sys.stderr)
        sys.exit(1)

    print("âœ… Updated deploy.json in 1Password")

if __name__ == "__main__":
    main()
