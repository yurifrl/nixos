#!/usr/bin/env python3
import json
import os
import subprocess
import sys
from pathlib import Path

def main():
    if len(sys.argv) < 2:
        print("Usage: get-latest-image [gatus|foundry]", file=sys.stderr)
        sys.exit(1)

    node_name = sys.argv[1]
    if node_name not in ["gatus", "foundry"]:
        print("Error: Node name must be either 'gatus' or 'foundry'", file=sys.stderr)
        sys.exit(1)

    # Load token from project root .env
    script_dir = Path(__file__).parent
    env_file = script_dir.parent / ".env"

    env_vars = {}
    with open(env_file) as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#") and "=" in line:
                key, value = line.split("=", 1)
                env_vars[key] = value.strip('"')

    token = env_vars.get("DIGITALOCEAN_API_TOKEN")
    if not token:
        print("Error: DIGITALOCEAN_API_TOKEN not set", file=sys.stderr)
        sys.exit(1)

    # Get latest image
    result = subprocess.run(
        [
            "doctl", "compute", "image", "list-user",
            "--access-token", token,
            "--format", "Name,Created",
            "--no-header"
        ],
        capture_output=True,
        text=True,
        check=True
    )

    # Find latest image for node
    latest = None
    for line in result.stdout.strip().split("\n"):
        if f"nixos-{node_name}-" in line:
            parts = line.split()
            if not latest or parts[1] > latest[1]:
                latest = parts

    if not latest:
        print(f"Error: No image found for node '{node_name}'", file=sys.stderr)
        sys.exit(1)

    # Output JSON for Terraform
    print(json.dumps({"image_name": latest[0]}))

if __name__ == "__main__":
    main()
